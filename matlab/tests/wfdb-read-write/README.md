# Comparing different tools for reading and writing WFDB compatible data files in C, MATLAB and Python

### Requirements
1. The WFDB software package in C: https://physionet.org/content/wfdb/10.7.0/ (https://github.com/bemoody/wfdb)
2. The Waveform Database Software Package (WFDB) for Python: https://physionet.org/content/wfdb-python/4.1.0/ (https://github.com/MIT-LCP/wfdb-python)
3. The Waveform Database Software Package (WFDB) for MATLAB and Octave: https://physionet.org/content/wfdb-matlab/0.10.0/ (https://github.com/ikarosilva/wfdb-app-toolbox)
4. WFDBCheck: https://github.com/bemoody/wfdbcheck

### Procedure
1. Run [prepare_sample_record.m](prepare_sample_record.m) in MATLAB to prepare a sample record in `.mat` and `.csv` formats, to be used for comparison. The sample record is assumed to have physical units.
1. Run [test_wfdb_read_write_matlab.m](test_wfdb_read_write_matlab.m) in MATLAB to convert the sample record to WFDB `.dat` and `.hea` files using `mat2wfdb`. This code compares two approaches: A) running `mat2wfdb` with the original physical units and allowing the function to select the correct scaling and baseline (`.dat` and `.hea` files with `mat2wfdb` postfix); B) scaling the signal to 16 bits using [DataScalingQuantization.m](DataScalingQuantization.m) and using the gain and baseline provided by this function (`.dat` and `.hea` files with `mat2wfdb_digital` postfix). The function also calculates the channel-wise gains and baseline values to be used in the C and Python versions.
2. [test_wfdb_read_write_matlab.m](test_wfdb_read_write_matlab.m) also saves the raw data matrix in CSV format, which is used by the other tools. 
3. Run the Jupyter Notebook [test_wfdb_read_write_python.ipynb](test_wfdb_read_write_python.ipynb), which runs the `csv_to_wfdb()` function from `wfdb-python` and generates the corresponding `.dat` and `.hea` files with `wfdbpython` postfix. 
4. Run the Bash script [test_wfdb_read_write_wrsamp.sh](test_wfdb_read_write_wrsamp.sh) in the terminal that runs `wrsamp` from the WFDB C version and generates the corresponding `.dat` and `.hea` files with `wrsamp` postfix
5. Run [test_compare_wfdb_conversions.sh](test_compare_wfdb_conversions.sh) to run `rdsamp`, which converts the different `.dat` and `.hea` versions generated above back to CSV format and also runs `wfdbcheck` to make sure that the data formats are correct to be exported to the PhysioNet database.

*Notes*:
- Run `chmod +x test_wfdb_read_write_wrsamp.sh` and `chmod +x test_compare_wfdb_conversions.sh` to grant execute permissions to the Bash scripts
- Make sure to update the paths to your Python packages when running the Jupyter Notebook


### Conclusion
1. The `wrsamp` C version doesn't support the `baseline` parameter.
<!--- 2. When `baseline` is non-zero, we occasionally get out-of-range and checksum errors in the Python version (needs further investigation) -->
2. Setting `baseline=0` and using the same gains (or setting the gain = 1) and baselines generated by the function `mat2wfdb` in MATLAB (see [test_wfdb_read_write_matlab.m](test_wfdb_read_write_matlab.m)), `wrsamp` (in C) and `csv_to_wfdb` (in Python) exactly generate the same results after conversion by `rdsamp`
3. When `baseline=0`, `mat2wfdb` in the digital mode, i.e., letting `mat2wfdb` to quantize the signal and to internally calculate the baseline and gain (see [test_wfdb_read_write_matlab.m](test_wfdb_read_write_matlab.m) for the outputs generated with `mat2wfdb_digital` postfix) almost perfectly matches the results from `wrsamp` and `csv_to_wfdb()`. The sample reconstruction errors are within +/-1 in 16-bits, which is only the rounding error.
4. `wrsamp` (in C) without providing the gains (without the `-x` flag) does not match after reconstruction
5. All the values (except the checksum) in the header file generated through `mat2wfdb` and `csv_to_wfdb()` are exactly the same. The gain and baseline values for the  `csv_to_wfdb()` are generated by the `mat2wfdb`
6. The adc gain value is uniform across all the three header file generated through C, python and MATLAB.
7. The checksum value is not matching across MATLAB and python: this is because [in the python script when calculating the checksum value](https://github.com/MIT-LCP/wfdb-python/blob/2cdb44ad0d4dbdfe5109a360a2e4d0ea4453b9f4/wfdb/io/_signal.py#L893), the script does not take into consideration the sign of the checksum. It computes the `mod` with only the positive 2^16 instead of the negative one, which is not identical to the design C feature that would result in an overflow of the checksum counter after exceeding the min and max of 16-bit integers [-2^15, 2^15).
8. All the values (except the adc_gain) wonâ€™t match with the header file generated through C because it has no baseline flag.
9. The `mat2wfdb` function does not have any adc_zero argument, it is assumed to be zero by the function definition (as highlighted in the function's description). The python funciton `csv_to_wfdb` has the adc_zero argument.

### Checksum calculation: wfdb-python
1. The checksum value is not matching across MATLAB and python: this is because [in the python script when calculating the checksum value](https://github.com/MIT-LCP/wfdb-python/blob/2cdb44ad0d4dbdfe5109a360a2e4d0ea4453b9f4/wfdb/io/_signal.py#L893), the script does not take into consideration the sign of the checksum. It computes the `mod` with only the positive 2^16 instead of the negative one, which is not identical to the design C feature that would result in an overflow of the checksum counter after exceeding the min and max of 16-bit integers [-2^15, 2^15).
2. the corrected logic for checksum calculation can be found here [_signal_modified.py](_signal_modified.py) 
3. The function computes the sum of the signal across all the channels and then normalizes the values with the maximum of the 16 bit signed range (2^15).
4. Then based on the sign of the channel sum the function computes the modulus of the values and takes care of the overflow condition.

### Contact
[Reza Sameni](mailto:rsameni@dbmi.emory.edu) and Deepanshi, 2003

[The Open-Source Electrophysiological Toolbox](https://github.com/alphanumericslab/OSET)


